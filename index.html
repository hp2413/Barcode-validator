<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Verifier</title>
    <!-- TailwindCSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QuaggaJS via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
    <style>
        /* QuaggaJS video styling */
        .viewport {
            position: relative;
        }
        .viewport canvas, .viewport video {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
        }
        .drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        /* Scanning guide overlay */
        .scan-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60px;
            border: 2px solid #ef4444;
            border-radius: 8px;
            background: rgba(239, 68, 68, 0.1);
            z-index: 10;
            pointer-events: none;
        }
        
        .scan-guide::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #ef4444;
            transform: translateY(-50%);
            animation: scan-line 2s ease-in-out infinite;
        }
        
        @keyframes scan-line {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Background transition */
        body {
            transition: background-color 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <main class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full max-w-lg mx-4">
        <h1 class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-6">Barcode Verifier</h1>

        <!-- Camera view will be injected here -->
        <div id="interactive" class="viewport w-full h-64 mb-6 rounded-lg overflow-hidden hidden relative">
            <div class="scan-guide"></div>
        </div>

        <!-- Buttons -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <button id="btn-scan" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                Scan Reference
            </button>
            <button id="btn-verify" class="w-full bg-gray-400 text-white font-bold py-3 px-4 rounded-lg cursor-not-allowed" disabled>
                Verify
            </button>
        </div>

        <!-- Results Display -->
        <div id="result-container" class="border-2 border-gray-300 p-4 rounded-lg text-center transition-all duration-300">
            <p class="text-gray-500 text-sm mb-2">Result</p>
            <p id="barcode-result" class="text-xl font-mono text-gray-800 break-words">
                Scan a reference barcode to start.
            </p>
            <p id="verification-result" class="text-lg font-semibold mt-2 h-7">
                <!-- Verification status will appear here -->
            </p>
        </div>

    </main>

    <script>
        // --- DOM ELEMENTS ---
        const scanButton = document.getElementById('btn-scan');
        const verifyButton = document.getElementById('btn-verify');
        const interactiveEl = document.getElementById('interactive');
        const resultContainer = document.getElementById('result-container');
        const barcodeResultEl = document.getElementById('barcode-result');
        const verificationResultEl = document.getElementById('verification-result');

        // --- STATE ---
        let referenceBarcode = null;
        let currentMode = ''; // 'scan' or 'verify'

        // --- HELPER FUNCTIONS ---
        function formatBarcodeNumber(barcodeData) {
            // The barcode data is already decoded from the black/white lines
            // Remove any non-numeric characters and format as numbers
            const numbersOnly = barcodeData.replace(/\D/g, '');
            return numbersOnly || barcodeData; // Return original if no numbers found
        }

        function setBackgroundColor(color) {
            document.body.className = document.body.className.replace(/bg-\w+-\d+/g, '') + ' ' + color;
        }

        // --- UI HELPER FUNCTIONS ---
        function resetUI() {
            // Reset state variable
            referenceBarcode = null;
            
            // Reset text
            barcodeResultEl.textContent = 'Scan a reference barcode to start.';
            verificationResultEl.textContent = '';
            
            // Reset result container styles
            resultContainer.classList.remove('border-green-500', 'border-red-500');
            resultContainer.classList.add('border-gray-300');
            
            // Reset verification text styles
            verificationResultEl.classList.remove('text-green-600', 'text-red-600');

            // Reset background color
            setBackgroundColor('bg-gray-100');

            // Disable verify button
            verifyButton.disabled = true;
            verifyButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            verifyButton.classList.remove('bg-green-600', 'hover:bg-green-700');
        }
        
        function updateUIAfterScan(barcodeData) {
            const formattedNumber = formatBarcodeNumber(barcodeData);
            barcodeResultEl.textContent = formattedNumber;
            
            // Enable verify button
            verifyButton.disabled = false;
            verifyButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            verifyButton.classList.add('bg-green-600', 'hover:bg-green-700');
        }

        function updateUIAfterVerification(isMatch) {
            if (isMatch) {
                verificationResultEl.textContent = 'Same';
                verificationResultEl.classList.add('text-green-600');
                verificationResultEl.classList.remove('text-red-600');
                resultContainer.classList.add('border-green-500');
                resultContainer.classList.remove('border-red-500', 'border-gray-300');
                
                // Set background to green
                setBackgroundColor('bg-green-200');
            } else {
                verificationResultEl.textContent = 'Different';
                verificationResultEl.classList.add('text-red-600');
                verificationResultEl.classList.remove('text-green-600');
                resultContainer.classList.add('border-red-500');
                resultContainer.classList.remove('border-green-500', 'border-gray-300');
                
                // Set background to red
                setBackgroundColor('bg-red-200');
            }
        }

        // --- QUAGGAJS FUNCTIONS ---
        function startScanner() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: interactiveEl,
                    constraints: {
                        width: { min: 640 },
                        height: { min: 480 },
                        facingMode: "environment", // 'environment' for back camera, 'user' for front
                        aspectRatio: { min: 1, max: 2 }
                    },
                },
                decoder: {
                    readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "code_39_vin_reader", "codabar_reader", "upc_reader", "upc_e_reader", "i2of5_reader"]
                },
            }, function (err) {
                if (err) {
                    console.error(err);
                    alert('Error initializing camera. Please grant permission and refresh.');
                    return;
                }
                console.log("Initialization finished. Ready to start.");
                Quagga.start();
                interactiveEl.classList.remove('hidden');
            });

            Quagga.onDetected(handleDetection);
        }

        function stopScanner() {
            Quagga.stop();
            interactiveEl.classList.add('hidden');
            Quagga.offDetected(handleDetection);
        }

        function handleDetection(data) {
            const barcodeData = data.codeResult.code;
            console.log('Detected barcode data:', barcodeData);
            
            stopScanner(); // Stop immediately after detection

            if (currentMode === 'scan') {
                referenceBarcode = barcodeData;
                updateUIAfterScan(barcodeData);
                verificationResultEl.textContent = ''; // Clear old verification result
                setBackgroundColor('bg-gray-100'); // Reset background
            } else if (currentMode === 'verify') {
                const formattedNumber = formatBarcodeNumber(barcodeData);
                barcodeResultEl.textContent = formattedNumber;
                const isMatch = (barcodeData === referenceBarcode);
                updateUIAfterVerification(isMatch);
            }
        }
        
        // --- EVENT LISTENERS ---
        scanButton.addEventListener('click', () => {
            resetUI();
            currentMode = 'scan';
            startScanner();
        });

        verifyButton.addEventListener('click', () => {
            if (!referenceBarcode) {
                alert("Please scan a reference barcode first.");
                return;
            }
            // Clear previous verification result before new scan
            verificationResultEl.textContent = '';
            verificationResultEl.classList.remove('text-green-600', 'text-red-600');
            resultContainer.classList.add('border-gray-300');
            resultContainer.classList.remove('border-green-500', 'border-red-500');
            setBackgroundColor('bg-gray-100'); // Reset background

            currentMode = 'verify';
            startScanner();
        });
    </script>
</body>
</html>
